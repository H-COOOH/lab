<html>
	<head>
		<script src="/js/an.js"></script>
		<title>Notes</title>
	</head>
	<body onload="L()">
		<h1>Notes</h1>
		<div id="help">
			<p><b>目录：</b><span id="how"></span></p>
			<ul id="main" style="font-size:18px;margin-left:2%;"></ul>
			<br><p><a href="./with.html">加密</a>&emsp;&emsp;<a href="/lab/index.html">返回</a></p>
		</div>
		<div id="less" style="display:none;">
			<p><b>目录：</b><span onclick="awaym(1)" style="color:lime;">Root</span><b>/</b><span style="color:lime;">回收站</span><b>/</b></p>
			<ul id="mean" style="font-size:18px;margin-left:2%;"></ul>
			<br><p><a href="./with.html">加密</a>&emsp;&emsp;<a href="/lab/index.html">返回</a></p>
		</div>
		<div id="showx" style="display:none;">
			<div onclick="move(1)">粘贴笔记</div>
			<div onclick="star()">新建笔记</div>
			<div onclick="add()">新建文件夹</div>
		</div>
		<div id="showy" style="display:none;">
			<div onclick="del()">删除</div>
			<div onclick="edt()">重命名</div>
		</div>
		<div id="showz" style="display:none;">
			<div onclick="view(0)">查看</div>
			<div onclick="view(1)">编辑</div>
			<div onclick="edit(0)">重命名</div>
			<div onclick="move(0)">剪切</div>
			<div onclick="edit(1)" style="color:red;">归档</div>
			<div onclick="remv()" style="color:red;">删除</div>
		</div>
		<div id="showt" style="display:none;">
			<div onclick="view(0)">查看</div>
			<div onclick="move(0)">剪切</div>
			<div onclick="real()" style="color:red;">删除</div>
		</div>
		<style>
			#showx,#showy,#showz,#showt
			{
				display:none;
				position:absolute;
				background-color:cyan;
			}
			#showx div,#showy div,#showz div,#showt div
			{
				padding:3px;
				border:1px solid;
				zoom:90%;
			}
		</style>
	</body>
	<script>
		var N,to,data,up,no,at,oh;
		var itto,toit,itis;
		var his=new Array(),As=1;
		var path,note,done,A;
		document.getElementById("main").oncontextmenu=function(o){showx(o);return false;}
		document.getElementById("mean").oncontextmenu=function(){return false;}
		document.onclick=function(){hide(0);}
		function L()
		{
			if (localStorage.dictwith=="true")
			{
				document.getElementById("help").style.display="none";
				window.location.href="./need.html";
				return;
			}
			var u=localStorage.dictlist,i=0;
			if (u==undefined)
			{
				u="";
				localStorage.dictlist="";
			}
			path=new Array(),note=new Array(),done=new Array(),A=0;
			for (var j=0;j<u.length;j++)
			{
				if (u[j]=="$")
				{A++;path[A]=u.substring(i,j);i=j+1;}
				else if (u[j]=="#")
				{note[A]=u.substring(i,j);done[A]=u[j+1]=="Y";i=j+2;}
			}
			u=localStorage.dictdata,i=0;
			if (u==undefined)
			{
				u="0|";
				localStorage.dictdata=u;
			}
			for (;u[i]!="|"&&i<u.length;i++);
			N=parseInt(u.substring(0,i));no=undefined;
			to=new Array();data=new Array();up=new Array();
			for (var j=0;j<=N;j++)
			{
				to[j]=new Array();
				to[j][0]=0;
			}
			his[1]=0;data[0]="Root";
			for (var j=1;j<=N;j++)
			{
				i++;var last=i;
				for (;u[i]!="Y"&&i<u.length;i++);
				var pa=parseInt(u.substring(last,i));
				to[pa][0]++;
				to[pa][to[pa][0]]=j;
				up[j]=pa;
			}
			for (var j=1;j<=N;j++)
			{
				i++;var last=i;
				for (;u[i]!="$"&&i<u.length;i++);
				data[j]=u.substring(last,i);
			}
			show();
		}
		function run(at)
		{
			itto[itis]=at;toit[at]=itis;
			for (var i=1;i<=to[at][0];i++)
			{
				if (to[at][i]!=no)
				{itis++;run(to[at][i]);}
			}
		}
		function storem()
		{
			itto=new Array();toit=new Array();
			itis=0;
			run(0);
			var re=String(itis)+"|";
			for (var i=1;i<=itis;i++)
			{re+=String(toit[up[itto[i]]])+"Y";}
			for (var i=1;i<=itis;i++)
			{re+=data[itto[i]]+"$";}
			localStorage.dictdata=re;
		}
		function storen()
		{
			var re="";
			for (var i=1;i<=A;i++)
			{
				if (done[i])
				{re+=path[i]+"$"+note[i]+"#Y";}
				else
				{re+=path[i]+"$"+note[i]+"#N";}
			}
			localStorage.dictlist=re;
		}
		function add()
		{
			at=his[As];
			var is=prompt("新建：");
			if (is==null||is=="")
			{return;}
			if (!checkm(at,is))
			{alert("已存在同名文件夹");return;}
			N++;to[at][0]++;
			to[at][to[at][0]]=N;
			to[N]=new Array();
			to[N][0]=0;
			up[N]=at;
			data[N]=is;
			storem();
			show();
		}
		function del()
		{
			if (!confirm("确定删除?\n此操作也将删除子目录")) {return;}
			no=at;
			storem();
			L();
		}
		function edt()
		{
			var is=prompt("重命名：",data[at]);
			if (is==null||is=="")
			{return;}
			if (!checkm(his[As],is))
			{alert("已存在同名文件夹");return;}
			var ro,re="",rd="",le;
			for (var i=1;i<=As;i++)
			{re+=data[his[i]]+"/";}
			ro=re+is+"/";
			re+=data[at]+"/";
			le=re.length;
			for (var i=1;i<=A;i++)
			{
				if (path[i].indexOf(re)!=0)
				{
					if (done[i])
					{rd+=path[i]+"$"+note[i]+"#Y";}
					else
					{rd+=path[i]+"$"+note[i]+"#N";}
				}
				else
				{
					if (done[i])
					{rd+=ro+path[i].substr(le)+"$"+note[i]+"#Y";}
					else
					{rd+=ro+path[i].substr(le)+"$"+note[i]+"#N";}
					localStorage.setItem(ro+path[i].substr(le)+"$"+note[i],localStorage.getItem(path[i]+"$"+note[i]));
					localStorage.removeItem(path[i]+"$"+note[i]);
					path[i]=ro+path[i].substr(le);
				}
			}
			localStorage.dictlist=rd;
			data[at]=is;
			var rg=String(N)+"|";
			for (var i=1;i<=N;i++)
			{rg+=String(up[i])+"Y";}
			for (var i=1;i<=N;i++)
			{rg+=data[i]+"$";}
			localStorage.dictdata=rg;
			show();
		}
		function show()
		{
			document.getElementById("less").style.display="none";
			document.getElementById("help").style.display="block";
			var as="",re="";
			for (var i=1;i<=As;i++)
			{as+=data[his[i]]+"/";re+="<span onclick='awaym("+String(i)+")' style=\"color:lime;\">"+String(data[his[i]])+"</span><b>/</b>";}
			document.getElementById("how").innerHTML=re;re="";
			if (his[As]==0)
			{re+="<li style=\"color:aqua\"><p style=\"color:black\"><span onclick=\"window.location.href='./set.html'\">设置</span></p></li><li style=\"color:gold\"><p style=\"color:black\"><span onclick=\"shows()\">回收站</span></p></li>";}
			for (var i=1;i<=to[his[As]][0];i++)
			{re+="<li><p><span class=\"es\" id=\"s"+String(to[his[As]][i])+"\" onclick='awayn("+String(to[his[As]][i])+")'>"+String(data[to[his[As]][i]])+"</span></p></li>";}
			for (var i=1;i<=A;i++)
			{
				if (as!=path[i]) {continue;}
				if (done[i])
				{re+="<li style=\"color:blue\"><p style=\"color:black\"><span class=\"et\" id=\"t"+String(i)+"\">"+note[i]+"</span></p></li>";}
				else
				{re+="<li style=\"color:red\"><p style=\"color:black\"><span class=\"et\" id=\"t"+String(i)+"\">"+note[i]+"</span></p></li>";}
			}
			if (re=="") {re="<p><i>文件夹为空</i></p>";}
			document.getElementById("main").innerHTML=re;
			var es=document.getElementsByClassName("es");
			for (var i=0;i<es.length;i++)
			{es[i].oncontextmenu=function(o){showy(o);return false;}}
			var et=document.getElementsByClassName("et");
			for (var i=0;i<et.length;i++)
			{et[i].oncontextmenu=function(o){showz(o);return false;}}
		}
		function awaym(at)
		{As=at;show();}
		function awayn(at)
		{As++;his[As]=at;show();}
		function showx(o)
		{
			if (o.target.tagName=="SPAN") {return;}
			if (oh==undefined)
			{document.getElementById("showx").children[0].style.display="none";}
			else
			{document.getElementById("showx").children[0].style.display="block";}
			document.getElementById("showx").style.left=String(o.pageX)+"px";
			document.getElementById("showx").style.top=String(o.pageY)+"px";
			hide(1);
		}
		function noy(at)
		{
			var re="";
			for (var i=1;i<=As;i++)
			{re+=data[his[i]]+"/";}
			re+=data[at]+"/";
			for (var i=1;i<=A;i++)
			{if (!path[i].indexOf(re)) {return true;}}
			return false;
		}
		function showy(o)
		{
			at=parseInt(o.target.id.substr(1));
			if (noy(at))
			{document.getElementById("showy").children[0].style.display="none";}
			else
			{document.getElementById("showy").children[0].style.display="block";}
			document.getElementById("showy").style.left=String(o.pageX)+"px";
			document.getElementById("showy").style.top=String(o.pageY)+"px";
			hide(2);
		}
		function showz(o)
		{
			at=parseInt(o.target.id.substr(1));
			if (done[at])
			{
				document.getElementById("showz").children[1].style.display="none";
				document.getElementById("showz").children[2].style.display="none";
				document.getElementById("showz").children[4].style.display="none";
			}
			else
			{
				document.getElementById("showz").children[1].style.display="block";
				document.getElementById("showz").children[2].style.display="block";
				document.getElementById("showz").children[4].style.display="block";
			}
			document.getElementById("showz").style.left=String(o.pageX)+"px";
			document.getElementById("showz").style.top=String(o.pageY)+"px";
			hide(3);
		}
		function showt(o)
		{
			at=parseInt(o.target.id.substr(1));
			document.getElementById("showt").style.left=String(o.pageX)+"px";
			document.getElementById("showt").style.top=String(o.pageY)+"px";
			hide(4);
		}
		function shows()
		{
			document.getElementById("help").style.display="none";
			document.getElementById("less").style.display="block";
			var re="";
			for (var i=1;i<=A;i++)
			{
				if (path[i]=="Root/回收站/")
				{re+="<li style=\"color:green\"><p style=\"color:black\"><span class=\"ed\" id=\"d"+String(i)+"\">"+note[i]+"</span></p></li>";}
			}
			if (re=="") {re="<p><i>回收站为空</i></p>";}
			document.getElementById("mean").innerHTML=re;
			var ed=document.getElementsByClassName("ed");
			for (var i=0;i<ed.length;i++)
			{ed[i].oncontextmenu=function(o){showt(o);return false;}}
		}
		function hide(o)
		{
			if (o==1) {document.getElementById("showx").style.display="block";}
			else {document.getElementById("showx").style.display="none";}
			if (o==2) {document.getElementById("showy").style.display="block";}
			else {document.getElementById("showy").style.display="none";}
			if (o==3) {document.getElementById("showz").style.display="block";}
			else {document.getElementById("showz").style.display="none";}
			if (o==4) {document.getElementById("showt").style.display="block";}
			else {document.getElementById("showt").style.display="none";}
		}
		function checkm(at,r)
		{
			if (at==0&&r=="回收站") {return false;}
			for (var i=1;i<=to[at][0];i++)
			{if (r==data[to[at][i]]) {return false;}}
			return true;
		}
		function checkn(r)
		{
			for (var i=1;i<=A;i++)
			{if (r==path[i]+"$"+note[i]) {return false;}}
			return true;
		}
		function star()
		{
			var re="";
			for (var i=1;i<=As;i++)
			{re+=data[his[i]]+"/"}
			var is=prompt("名称：");
			if (is==null||is=="")
			{return;}
			var ch=re+"$"+is;
			if (!checkn(ch))
			{alert("已存在同名文件");return;}
			localStorage.setItem(ch,"");
			A++;path[A]=re;note[A]=is;done[A]=false;
			storen();
			show();
		}
		function view(r)
		{
			if (r)
			{sessionStorage.ntename=path[at]+"$"+note[at];window.open("edit.html");}
			else
			{sessionStorage.ntvname=path[at]+"$"+note[at];window.open("view.html");}
		}
		function edit(r)
		{
			if (r)
			{
				if (!confirm("确定归档?\n此操作不可恢复!")) {return;}
				done[at]=true;
			}
			else
			{
				var ed=note[at],is=prompt("名称：",ed);
				if (is==null||is=="") {return;}
				var ch=path[at]+"$"+is;
				if (!checkn(ch))
				{alert("已存在同名文件");return;}
				localStorage.setItem(ch,localStorage.getItem(path[at]+"$"+ed));
				localStorage.removeItem(path[at]+"$"+ed);
				note[at]=is;
			}
			storen();show();
		}
		function remv()
		{
			var ed=path[at],si=undefined;
			path[at]="Root/回收站/";
			for (var i=1;i<=A;i++)
			{if (i!=at&&path[i]==path[at]&&note[i]==note[at]) {si=i;break;}}
			if (si==undefined) {storen();}
			else
			{
				if (!confirm("回收站已存在同名文件\n确定覆盖?\n此操作不可恢复!")) {path[at]=ed;return;}
				deal(si);
				if (at>si) {at--;}
			}
			if (oh==at) {oh=undefined}
			localStorage.setItem(path[at]+"$"+note[at],localStorage.getItem(ed+"$"+note[at]));
			localStorage.removeItem(ed+"$"+note[at]);
			show();
		}
		function move(r)
		{
			if (r)
			{
				var ed=path[oh],re="";
				for (var i=1;i<=As;i++)
				{re+=data[his[i]]+"/";}
				var ch=re+"$"+note[oh];
				if (!checkn(ch))
				{alert("已存在同名文件");return;}
				localStorage.setItem(ch,localStorage.getItem(ed+"$"+note[oh]));
				localStorage.removeItem(ed+"$"+note[oh]);
				path[oh]=re;oh=undefined;storen();show();
			}
			else
			{oh=at;}
		}
		function real()
		{
			if (!confirm("确定删除?\n此操作不可恢复!")) {return;}
			deal(at);shows();
		}
		function deal(at)
		{
			if (oh==at) {oh=undefined}
			else if (oh>at) {oh--;}
			localStorage.removeItem(path[at]+"$"+note[at]);
			for (var i=at;i<=A;i++)
			{path[i]=path[i+1];note[i]=note[i+1];done[i]=done[i+1];}
			A--;storen();
		}
	</script>
</html>